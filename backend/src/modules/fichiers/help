//partage du fichier par lien 


// import { PutObjectCommand } from "@aws-sdk/client-s3";
// import { getSignedUrl } from "@aws-sdk/s3-request-presigner";

// export const partagerFichierDecryptÃ© = async (req, res) => {
//   const { fichier_id, entreprise_id } = req.params;

//   try {
//     const { rows } = await pool.query('SELECT * FROM fichiers WHERE fichier_id = $1', [fichier_id]);
//     if (rows.length === 0) return res.status(404).json({ error: 'Fichier introuvable' });

//     const fichier = rows[0];
//     const chemin = fichier.chemin;
//     const s3BaseUrl = 'https://arkiva-storage.s3.amazonaws.com/';
//     const key = chemin.replace(s3BaseUrl, '');

//     // 1. TÃ©lÃ©charger le fichier chiffrÃ©
//     const encryptedBuffer = await downloadFileBufferFromS3(key);

//     // 2. DÃ©chiffrer le fichier
//     const { content: decryptedBuffer, originalFileName } = await encryptionService.decryptFile(encryptedBuffer, entreprise_id);

//     // 3. DÃ©terminer le type MIME
//     const mimeType = mime.lookup(originalFileName) || 'application/octet-stream';

//     // 4. DÃ©finir un chemin temporaire pour le fichier dÃ©chiffrÃ©
//     const tempKey = `temp-share/${entreprise_id}-${Date.now()}-${originalFileName}`;

//     // 5. Upload du fichier dÃ©chiffrÃ© en clair dans S3
//     await s3.send(new PutObjectCommand({
//       Bucket: process.env.AWS_S3_BUCKET_NAME,
//       Key: tempKey,
//       Body: decryptedBuffer,
//       ContentType: mimeType,
//       ContentDisposition: `attachment; filename="${originalFileName}"`,
//     }));

//     // 6. GÃ©nÃ©rer un lien signÃ© temporaire (valable 1h)
//     const command = new GetObjectCommand({
//       Bucket: process.env.AWS_S3_BUCKET_NAME,
//       Key: tempKey,
//     });

//     const signedUrl = await getSignedUrl(s3, command, { expiresIn: 60 * 60 });

//     res.json({ lien: signedUrl });

//   } catch (err) {
//     console.error(err);
//     res.status(500).json({ error: 'Erreur lors du partage du fichier dÃ©chiffrÃ©' });
//   }
// };


// TrÃ¨s bien, voici comment tu peux faire les deux options pour gÃ©rer automatiquement la suppression des fichiers dÃ©chiffrÃ©s temporairement uploadÃ©s sur S3.

// âœ… 1. Configuration dâ€™une "Lifecycle Rule" sur S3 (auto-suppression aprÃ¨s 24h)
// ğŸªœ Ã‰tapes sur AWS Console :
// Va dans la console AWS S3.

// Clique sur ton bucket (ex: arkiva-storage).

// Onglet "Management" > section "Lifecycle rules".

// Clique sur "Create lifecycle rule".

// ğŸ“ Configuration :
// Nom de la rÃ¨gle : TempShareExpiry

// Scope : Limit the scope... â†’ coche "Prefix" et mets :

// pgsql
// Copier
// Modifier
// temp-share/
// Transitions : (aucune, laisse vide)

// Expiration :
// âœ… Coche "Expire current versions of objects"
// â†’ Mets 1 jour (ou 1 pour 24h)

// âœ… RÃ©sultat :
// Tous les fichiers qui commencent par temp-share/ seront automatiquement supprimÃ©s aprÃ¨s 1 jour.

